# Письмо в поддержку CloudPayments

**Тема:** Проблема с сохранением карт при использовании saveCard: true

---

Здравствуйте!

Обращаюсь к вам с проблемой сохранения карт в CloudPayments. 

**Описание проблемы:**

При использовании виджета CloudPayments с параметром `saveCard: true` карта не сохраняется автоматически для указанного `accountId`. 

**Детали:**

1. **Настройки CloudPayments:**
   - В личном кабинете CloudPayments в разделе "Сайты" → "Данные карты" установлено:
     - ✅ Сохранение карт включено
     - ✅ Режим "Принудительно" (карта должна сохраняться автоматически)

2. **Используемый метод:**
   - Виджет CloudPayments: `widget.auth()` с параметрами:
     ```javascript
     {
       publicId: "...",
       description: "Привязка карты к Stiger",
       amount: 1,
       currency: "RUB",
       accountId: "telegram_8141463258",
       saveCard: true
     }
     ```

3. **Что происходит:**
   - Транзакция успешно проходит (статус: Completed)
   - В вебхуке от CloudPayments приходит `Token` (например: `tk_0d534974821e77c070635896d265a`)
   - В вебхуке приходит `AccountId: telegram_8141463258`
   - Но при запросе списка карт через API `/cards/list` с тем же `AccountId` возвращается ошибка: `404 - not found`

4. **Логи API запроса:**
   ```
   POST https://api.cloudpayments.ru/cards/list
   Body: { "AccountId": "telegram_8141463258" }
   
   Response: {
     "Success": false,
     "Message": "404 - not found"
   }
   ```

5. **Пример транзакции:**
   - TransactionId: 3160958064
   - AccountId: telegram_8141463258
   - Token: tk_0d534974821e77c070635896d265a
   - Status: Completed
   - CardLastFour: 0665
   - CardFirstSix: 220070

**Ожидаемое поведение:**

При использовании `saveCard: true` и настройке "Принудительно" карта должна автоматически сохраняться для указанного `accountId` и быть доступной через API `/cards/list`.

**Фактическое поведение:**

Карта не сохраняется, хотя транзакция успешна и в вебхуке приходит `Token`.

**Вопросы:**

1. Почему карта не сохраняется автоматически при `saveCard: true` и настройке "Принудительно"?
2. Есть ли дополнительные требования для сохранения карт, которые мы не учитываем?
3. Нужно ли выполнять дополнительные действия после успешной транзакции для сохранения карты?
4. Может ли быть проблема в формате `accountId` (используем формат `telegram_8141463258`)?

**Дополнительная информация:**

- Используем двухстадийную оплату (`auth`)
- Настройки CloudPayments: "Принудительно" для сохранения карт
- `accountId` одинаковый при привязке карты и при запросе списка карт
- Проблема воспроизводится стабильно

Пожалуйста, помогите разобраться с этой проблемой. Готов предоставить дополнительную информацию при необходимости.

С уважением,
[Ваше имя]
[Ваш email]
[Ваш телефон]

---

**P.S.** Если это известная проблема, подскажите, пожалуйста, есть ли обходное решение или когда ожидается исправление.


